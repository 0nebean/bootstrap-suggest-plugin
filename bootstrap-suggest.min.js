/*
Bootstrap_Search_Suggest - v0.0.1
Description: 这是一个基于 bootstrap 按钮式下拉菜单组件的搜索建议插件，必须使用于按钮式下拉菜单组件上。
Author: lizhiwen#meizu.com
Update: 2014-10-22 15:06:20
*/
!function(a){a.fn.bsSuggest=function(a){return"string"==typeof a&&b[a]?b[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?void 0:b.init.apply(this,arguments)};var b={init:function(b){function c(a,b){return""===a.val()||-1===b.indexId||b.multiWord||""!==a.attr("data-id")?a.css("background","rgba(255,255,255,.1)"):a.css("background",b.inputWarnColor||"rgba(255,255,0,.1)")}function d(a,b){var c,d,e=a.parent().find("tbody tr."+q.listHoverCSS);e.length>0&&(c=(e.index()+3)*e.height(),d=Number(b.css("max-height").replace("px","")),b.scrollTop(c>d||b.scrollTop()>d?c-d:0))}function e(a,b){a=a||$dropdownMenu,b=b||q,a.find("tr."+b.listHoverCSS).removeClass(b.listHoverCSS)}function f(b){var c=a(b),d=c.parent(".input-group").find("ul.dropdown-menu"),e=c.data("bsSuggest");return 0===d.length?!1:e?!1:(c.data("bsSuggest",{target:b,options:q}),!0)}function g(b,c,d,e){var f,g,h,k,l,m,n,p={value:[]};if(b=b||"",e=e||q,e.url)l=-1!==e.url.indexOf("?")?"&":"?",m=e.jsonp?[e.url+b,l,e.jsonp,"=?"].join(""):e.url+b,a.ajax({type:"GET",url:m,dataType:"json",timeout:3e3}).done(function(a){d(c,a,e)}).fail(o);else{if(f=e.data,g=i(f))for(n=f.value.length,h=0;n>h;h++)for(k in f.value[h])if(a.trim(f.value[h][k])&&j(k)===!0&&(-1!==f.value[h][k].toString().indexOf(b)||-1!==b.indexOf(f.value[h][k]))){p.value.push(f.value[h]);break}d(c,p,e)}}function h(a){return validData=i(a)}function i(a){var b=!0;for(var c in a)if("value"===c){b=!1;break}return b?(o("返回数据格式错误!"),!1):0===a.value.length?(o("返回数据为空!"),!1):a}function j(c){return a.isArray(b.effectiveFields)&&b.effectiveFields.length>0&&-1===a.inArray(c,b.effectiveFields)?!1:!0}function k(a,b,c){var d,e,f,g=a.parent().find("ul.dropdown-menu"),i=0,k='<table class="table table-condensed">',m="<thead><tr>";if(c=c||q,b=h(b),b===!1||0===(d=b.value.length))return g.empty().hide();for(f in b.value[0])j(f)!==!1&&(m+=0===i?"<th>"+f+"("+d+")</th>":"<th>"+f+"</th>",i++);for(m+="</tr></thead>",2>i&&(m=""),k+=m+"<tbody>",e=0;d>e;e++){k+="<tr data-index="+e+">",i=0;for(f in b.value[e])j(f)!==!1&&(k+=c.indexId===i&&c.indexKey===i?'<td data-name="'+f+'" class="indexid indexkey">'+b.value[e][f]+"</td>":c.indexId===i?'<td data-name="'+f+'" class="indexid">'+b.value[e][f]+"</td>":c.indexKey===i?'<td data-name="'+f+'" class="indexkey">'+b.value[e][f]+"</td>":'<td data-name="'+f+'">'+b.value[e][f]+"</td>",i++);k+="</tr>"}k+="</tbody></table>",g.html(k).show(),l(a,g,c),g.css("max-height")&&g.css("max-height")===g.css("height")&&g.css("min-width")&&g.css("min-width")!==g.css("width")?g.css("padding-right","20px"):g.css("padding-right","")}function l(b,c,d){c=c||$dropdownMenu,d=d||q,c.find("tbody tr").each(function(){a(this).off("mouseenter").on("mouseenter",function(){e(c,d),a(this).addClass(d.listHoverCSS)}).off("mousedown").on("mousedown",function(){n(b,m(a(this)),d)})})}function m(a){var b={};return b.id=a.find("td.indexid").text(),b.key=a.find("td.indexkey").text(),b}function n(a,b,c){var d,e=b||{},f=e.id||"",g=e.key||"";c&&c.multiWord?(d=a.val().split(c.separator||" "),d[d.length-1]=g,a.val(d.join(c.separator||" ")).focus()):a.attr("data-id",f).focus().val(g)}function o(a){console.log(a)}var p=this,q=a.extend({url:null,jsonp:null,data:{},getDataMethod:"firstByUrl",indexId:0,indexKey:0,effectiveFields:null,allowNoKeyword:!0,multiWord:!1,separator:" ",processData:h,getData:g,autoMinWidth:!1,inputWarnColor:"rgba(255,0,0,.1)",listStyle:{"max-height":"375px","max-width":"800px",overflow:"auto"},listHoverStyle:"background: #07d; color:#fff",listHoverCSS:"jhover",keyLeft:37,keyUp:38,keyRight:39,keyDown:40,keyEnter:13},b);if(a.isFunction(q.processData)&&(h=q.processData),a.isFunction(q.getData)&&(g=q.getData),"firstByUrl"===q.getDataMethod&&q.url){var r=-1!==b.url.indexOf("?")?"&":"?",s=b.jsonp?[b.url,r,b.jsonp,"=?"].join(""):b.url;a.ajax({type:"GET",url:s,dataType:"json",timeout:5e3}).done(function(a){q.data=a,q.url=null}).fail(function(a){throw new Error(a)})}return a("head:eq(0)").append("<style>."+q.listHoverCSS+"{"+q.listHoverStyle+"}</style>"),p.each(function(){var h=a(this),i=h.parent(".input-group").find("ul.dropdown-menu");f(this)!==!1&&(h.removeClass("disabled").attr("autocomplete","off"),i.css(q.listStyle||{"max-height":"300px","max-width":"800px",overflow:"auto"}),q.autoMinWidth===!1&&i.css("min-width",a("#test").parent().width()),h.on("keydown",function(f){var g,j="";"none"!==i.css("display")&&(g=i.find("."+q.listHoverCSS),j="",f.keyCode===q.keyDown?(0===g.length?j=m(i.find("table tbody tr:first").mouseover()):0===g.next().length?(e(i,q),a(this).val(a(this).attr("alt")).attr("data-id","")):(e(i,q),0!==g.next().length&&(j=m(g.next().mouseover()))),d(h,i)):f.keyCode===q.keyUp?(0===g.length?j=m(i.find("table tbody tr:last").mouseover()):0===g.prev().length?(e(i,q),a(this).val(a(this).attr("alt")).attr("data-id","")):(e(i,q),0!==g.prev().length&&(j=m(g.prev().mouseover()))),d(h,i)):f.keyCode===q.keyEnter?i.hide().empty():a(this).attr("data-id",""),j&&""!==j.key&&n(a(this),j,b),c(h,q))}).on("keyup",function(){var c,d;return event.keyCode===q.keyDown||event.keyCode===q.keyUp||event.keyCode===q.keyEnter?void a(this).val(a(this).val()):(c=a(this).val(),void((""===a.trim(c)||c!==a(this).attr("alt"))&&(a(this).attr("alt",a(this).val()),b.multiWord&&(d=c.split(q.separator||" "),c=d[d.length-1]),(0!==c.length||q.allowNoKeyword===!0)&&g(a.trim(c),h,k,q))))}).on("focus",function(){}).on("blur",function(){i.css("display","")}).on("click",function(){var b,c=a(this).val();""!==a.trim(c)&&c===a(this).attr("alt")||"none"!==i.css("display")||(q.multiWord&&(b=c.split(q.separator||" "),c=b[b.length-1]),(0!==c.length||q.allowNoKeyword===!0)&&g(a.trim(c),h,k,q))}),a(this).parent().find("button:eq(0)").on("click",function(){p.click().focus()}))})},show:function(){var a=this.data("bsSuggest");return a&&a.options&&this.parent().find("ul.dropdown-menu").show(),this},hide:function(){var a=this.data("bsSuggest");return a&&a.options&&this.parent().find("ul.dropdown-menu").css("display",""),this},disable:function(){a(this).attr("disabled",!0).parent().find("button").addClass("disabled")},enable:function(){a(this).attr("disabled",!1).parent().find("button").removeClass("disabled")},destroy:function(){a(this).off().data(""),a(this).parent().find("button").off()}}}(window.jQuery);