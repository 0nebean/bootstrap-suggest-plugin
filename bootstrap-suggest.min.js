/*
Bootstrap_Search_Suggest - v0.0.1
Description: 这是一个基于 bootstrap 按钮式下拉菜单组件的搜索建议插件，必须使用于按钮式下拉菜单组件上。
Author: lizhiwen#meizu.com
Update: 2014-11-18 17:13:31
*/
!function(a){a.fn.bsSuggest=function(a){return"string"==typeof a&&b[a]?b[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?void 0:b.init.apply(this,arguments)};var b={init:function(b){function c(a,b){return-1===b.indexId&&!b.idField||b.multiWord?a:!a.val()||a.attr("data-id")?a.css("background","rgba(255,255,255,.1)"):a.css("background",b.inputWarnColor||"rgba(255,255,0,.1)")}function d(a,b){var c,d,e=a.parent().find("tbody tr."+q.listHoverCSS);e.length>0&&(c=(e.index()+3)*e.height(),d=Number(b.css("max-height").replace("px","")),b.scrollTop(c>d||b.scrollTop()>d?c-d:0))}function e(a,b){a=a||$dropdownMenu,b=b||q,a.find("tr."+b.listHoverCSS).removeClass(b.listHoverCSS)}function f(b){var c=a(b),d=c.parent(".input-group").find("ul.dropdown-menu"),e=c.data("bsSuggest");return 0===d.length?!1:e?!1:(c.data("bsSuggest",{target:b,options:q}),!0)}function g(b,c,d,e){var f,g,h,k,l,m,n,p={value:[]};if(b=b||"",e=e||q,e.url)l=-1!==e.url.indexOf("?")?"&":"?",m=e.jsonp?[e.url+b,l,e.jsonp,"=?"].join(""):e.url+b,a.ajax({type:"GET",url:m,dataType:"json",timeout:3e3}).done(function(a){d(c,a,e),c.trigger("dataRequestSuccess",a)}).fail(o);else{if(f=e.data,g=i(f))for(n=f.value.length,h=0;n>h;h++)for(k in f.value[h])if(a.trim(f.value[h][k])&&j(k)===!0&&(-1!==f.value[h][k].toString().indexOf(b)||-1!==b.indexOf(f.value[h][k]))){p.value.push(f.value[h]);break}d(c,p,e)}}function h(a){return validData=i(a)}function i(a){var b=!0;for(var c in a)if("value"===c){b=!1;break}return b?(o("返回数据格式错误!"),!1):0===a.value.length?(o("返回数据为空!"),!1):a}function j(c){return a.isArray(b.effectiveFields)&&b.effectiveFields.length>0&&-1===a.inArray(c,b.effectiveFields)?!1:!0}function k(a,b,c){var d,e,f,g,i,k,m=a.parent().find("ul.dropdown-menu"),n=0,o='<table class="table table-condensed">',p="<thead><tr>";if(c=c||q,b=h(b),b===!1||0===(d=b.value.length))return m.empty().hide(),a;if(c.showHeader){for(f in b.value[0])j(f)!==!1&&(p+=0===n?"<th>"+(c.effectiveFieldsAlias[f]||f)+"("+d+")</th>":"<th>"+(c.effectiveFieldsAlias[f]||f)+"</th>",n++);p+="</tr></thead>",o+=p}for(o+="<tbody>",e=0;d>e;e++){n=0,g="",i=b.value[e][c.idField]||"",k=b.value[e][c.keyField]||"";for(f in b.value[e])k||c.indexKey!==n||(k=b.value[e][f]),i||c.indexId!==n||(i=b.value[e][f]),n++,j(f)!==!1&&(g+='<td data-name="'+f+'">'+b.value[e][f]+"</td>");g='<tr data-index="'+e+'" data-id="'+i+'" data-key="'+k+'">'+g+"</tr>",o+=g}return o+="</tbody></table>",m.html(o).show(),l(a,m,c),m.css("max-height")&&Number(m.css("max-height").replace("px",""))<Number(m.find("table:eq(0)").css("height").replace("px",""))&&Number(m.css("min-width").replace("px",""))<Number(m.css("width").replace("px",""))?m.css("padding-right","20px").find("table:eq(0)").css("margin-bottom","20px"):m.css("padding-right",0).find("table:eq(0)").css("margin-bottom",0),a}function l(b,d,f){d=d||$dropdownMenu,f=f||q,d.find("tbody tr").each(function(){a(this).off("mouseenter").on("mouseenter",function(){e(d,f),a(this).addClass(f.listHoverCSS)}).off("mousedown").on("mousedown",function(){n(b,m(a(this)),f),c(b,f)})})}function m(a){var b={};return b.id=a.attr("data-id"),b.key=a.attr("data-key"),b}function n(a,b,c){var d,e=b||{},f=e.id||"",g=e.key||"";c&&c.multiWord?(d=a.val().split(c.separator||" "),d[d.length-1]=g,a.val(d.join(c.separator||" ")).focus()):a.attr("data-id",f).focus().val(g)}function o(a){console.log(a)}var p=this,q=a.extend({url:null,jsonp:null,data:{value:[{id:"0",word:"lzw",description:"http://lzw.me"},{id:"1",word:"lzwme",description:"http://w.lzw.me"},{id:"2",word:"meizu",description:"http://www.meizu.com"},{id:"3",word:"flyme",description:"http://flyme.meizu.com"}]},getDataMethod:"firstByUrl",indexId:0,indexKey:0,idField:"",keyField:"",effectiveFields:[],effectiveFieldsAlias:{userName:"姓名"},showHeader:!1,allowNoKeyword:!0,multiWord:!1,separator:",",processData:h,getData:g,autoMinWidth:!1,inputWarnColor:"rgba(255,0,0,.1)",listStyle:{"padding-top":0,"max-height":"375px","max-width":"800px",overflow:"auto",width:"auto"},listHoverStyle:"background: #07d; color:#fff",listHoverCSS:"jhover",keyLeft:37,keyUp:38,keyRight:39,keyDown:40,keyEnter:13},b);if(a.isFunction(q.processData)&&(h=q.processData),a.isFunction(q.getData)&&(g=q.getData),!b.showHeader&&q.effectiveFields&&q.effectiveFields.length>1&&(q.showHeader=!0),"firstByUrl"===q.getDataMethod&&q.url){var r=-1!==b.url.indexOf("?")?"&":"?",s=b.jsonp?[b.url,r,b.jsonp,"=?"].join(""):b.url;a.ajax({type:"GET",url:s,dataType:"json",timeout:5e3}).done(function(b){q.data=b,q.url=null,a(p).trigger("dataRequestSuccess",b)}).fail(function(a){throw new Error(a)})}return a("head:eq(0)").append("<style>."+q.listHoverCSS+"{"+q.listHoverStyle+"}</style>"),p.each(function(){var h=a(this),i=h.parent(".input-group").find("ul.dropdown-menu");f(this)!==!1&&(h.removeClass("disabled").attr("disabled",!1).attr("autocomplete","off"),i.css(q.listStyle||{"max-height":"300px","max-width":"800px",overflow:"auto"}),q.autoMinWidth===!1?i.css({"min-width":h.parent().width()}):i.css("width","auto"),h.on("keydown",function(b){var c,f="";"none"!==i.css("display")&&(c=i.find("."+q.listHoverCSS),f="",b.keyCode===q.keyDown?(0===c.length?f=m(i.find("table tbody tr:first").mouseover()):0===c.next().length?(e(i,q),a(this).val(a(this).attr("alt")).attr("data-id","")):(e(i,q),0!==c.next().length&&(f=m(c.next().mouseover()))),d(h,i)):b.keyCode===q.keyUp?(0===c.length?f=m(i.find("table tbody tr:last").mouseover()):0===c.prev().length?(e(i,q),a(this).val(a(this).attr("alt")).attr("data-id","")):(e(i,q),0!==c.prev().length&&(f=m(c.prev().mouseover()))),d(h,i)):b.keyCode===q.keyEnter?i.hide().empty():a(this).attr("data-id",""),f&&""!==f.key&&n(a(this),f,q))}).on("keyup",function(d){var e,f;return d.keyCode===q.keyDown||d.keyCode===q.keyUp||d.keyCode===q.keyEnter?(a(this).val(a(this).val()),void c(h,q)):(a(this).attr("data-id",""),c(h,q),e=a(this).val(),void((""===a.trim(e)||e!==a(this).attr("alt"))&&(a(this).attr("alt",a(this).val()),b.multiWord&&(f=e.split(q.separator||" "),e=f[f.length-1]),(0!==e.length||q.allowNoKeyword)&&g(a.trim(e),h,k,q))))}).on("focus",function(){}).on("blur",function(){i.css("display","")}).off("click").on("click",function(){var b,c=a(this).val();""!==a.trim(c)&&c===a(this).attr("alt")||"none"!==i.css("display")||(q.multiWord&&(b=c.split(q.separator||" "),c=b[b.length-1]),(0!==c.length||q.allowNoKeyword)&&g(a.trim(c),h,k,q))}),h.parent().find("button:eq(0)").off().on("click",function(){q.url?h.click().focus():k(h,q.data,q)}))})},show:function(){var a=this.data("bsSuggest");return a&&a.options&&this.parent().find("ul.dropdown-menu").show(),this},hide:function(){var a=this.data("bsSuggest");return a&&a.options&&this.parent().find("ul.dropdown-menu").css("display",""),this},disable:function(){return a(this).data("bsSuggest")?void a(this).attr("disabled",!0).parent().find("button").addClass("disabled"):!1},enable:function(){return a(this).data("bsSuggest")?void a(this).attr("disabled",!1).parent().find("button").removeClass("disabled"):!1},destroy:function(){a(this).off().data("bsSuggest",""),a(this).parent().find("button").off()}}}(window.jQuery);